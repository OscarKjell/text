name: Install benchmark (text)

on:
  workflow_dispatch:

jobs:
  benchmark:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, windows-latest]

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      # Force a clean R library location for this run
      R_LIBS_USER: ${{ runner.temp }}/Rlib

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"

      # ---- OS prerequisites (keep minimal; adjust as needed) ----
      - name: Linux system deps (minimal)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
            libharfbuzz-dev libfribidi-dev libcairo2-dev libgit2-dev
        shell: bash

      - name: macOS deps (libomp + qpdf)
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install libomp || true
          brew install qpdf || true
          echo "DYLD_LIBRARY_PATH=$(brew --prefix libomp)/lib" >> $GITHUB_ENV
        shell: bash

      # ---- Benchmark script ----
      - name: Benchmark install (R + textrpp)
        run: |
          dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)

          # helper for timing
          run_timed <- function(label, expr) {
            gc()
            t0 <- Sys.time()
            force(expr)
            t1 <- Sys.time()
            secs <- as.numeric(difftime(t1, t0, units = "secs"))
            cat(sprintf("\nBENCHMARK|%s|%.1f seconds\n", label, secs))
            return(secs)
          }

          # Make sure we have basic tooling
          run_timed("install_remotes", install.packages("remotes", repos = "https://cloud.r-project.org"))

          # Install 'text' from GitHub (your main measurement)
          t_text <- run_timed(
            "install_text_from_github",
            remotes::install_github("oscarkjell/text", upgrade = "never", dependencies = TRUE)
          )

          # Time the Python backend install
          t_textrpp <- run_timed(
            "textrpp_install",
            { library(text); text::textrpp_install(prompt = FALSE) }
          )

          # Optional sanity check (separate number)
          t_init <- run_timed(
            "textrpp_initialize_test",
            { library(text); text::textrpp_initialize(textEmbed_test = TRUE) }
          )

          # Write a tiny machine-readable summary
          out <- data.frame(
            os = Sys.info()[["sysname"]],
            install_text_from_github_s = t_text,
            textrpp_install_s = t_textrpp,
            textrpp_initialize_test_s = t_init,
            total_s = t_text + t_textrpp + t_init
          )
          print(out)

          dir.create("bench", showWarnings = FALSE)
          write.csv(out, file = "bench/install-benchmark.csv", row.names = FALSE)
        shell: Rscript {0}

      - name: Upload benchmark artifact
        uses: actions/upload-artifact@v4
        with:
          name: install-benchmark-${{ matrix.os }}
          path: bench/install-benchmark.csv
