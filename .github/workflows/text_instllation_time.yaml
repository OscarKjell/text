name: Install benchmark (text)

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  benchmark:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, windows-latest]

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: "release"

      # Set a clean R library folder for the run (works across OS)
      - name: Set clean R library path
        run: |
          echo "R_LIBS_USER=${RUNNER_TEMP}/Rlib" >> $GITHUB_ENV
        shell: bash

      # ---- OS prerequisites ----
      - name: Linux system deps (incl Java)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            default-jdk \
            libcurl4-openssl-dev libssl-dev libxml2-dev \
            libfontconfig1-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
            libharfbuzz-dev libfribidi-dev libcairo2-dev libgit2-dev
          # Optional but nice if anything uses Java config:
          sudo R CMD javareconf || true
        shell: bash

      - name: macOS deps (libomp + qpdf)
        if: runner.os == 'macOS'
        run: |
          brew update || true
          brew install libomp || true
          brew install qpdf || true
          echo "DYLD_LIBRARY_PATH=$(brew --prefix libomp)/lib" >> $GITHUB_ENV
        shell: bash

      # ---- Benchmark script ----
      - name: Benchmark install (R + textrpp)
        run: |
          # Ensure R uses the user library FIRST (avoids /opt/R not writable on Linux)
          userlib <- Sys.getenv("R_LIBS_USER")
          dir.create(userlib, recursive = TRUE, showWarnings = FALSE)
          .libPaths(c(userlib, .libPaths()))

          cat("R_LIBS_USER:", userlib, "\n")
          cat("libPaths:\n"); print(.libPaths())

          run_timed <- function(label, expr) {
            gc()
            t0 <- Sys.time()
            force(expr)
            t1 <- Sys.time()
            secs <- as.numeric(difftime(t1, t0, units = "secs"))
            cat(sprintf("\nBENCHMARK|%s|%.1f seconds\n", label, secs))
            return(secs)
          }

          repos <- "https://cloud.r-project.org"

          # Tooling
          run_timed(
            "install_remotes",
            install.packages("remotes", repos = repos, lib = userlib)
          )
          library(remotes, lib.loc = userlib)

          # Install 'text' from GitHub (main measurement)
          t_text <- run_timed(
            "install_text_from_github",
            remotes::install_github(
              "oscarkjell/text",
              upgrade = "never",
              dependencies = TRUE,
              lib = userlib
            )
          )

          # Time the Python backend install
          # (This should now actually run on Linux since default-jdk is installed.)
          t_textrpp <- run_timed(
            "textrpp_install",
            { library(text, lib.loc = userlib); text::textrpp_install(prompt = FALSE) }
          )

          # Optional sanity check (separate number)
          t_init <- run_timed(
            "textrpp_initialize_test",
            { library(text, lib.loc = userlib); text::textrpp_initialize(textEmbed_test = TRUE) }
          )

          out <- data.frame(
            os = Sys.info()[["sysname"]],
            r_version = as.character(getRversion()),
            install_text_from_github_s = t_text,
            textrpp_install_s = t_textrpp,
            textrpp_initialize_test_s = t_init,
            total_s = t_text + t_textrpp + t_init
          )
          print(out)

          dir.create("bench", showWarnings = FALSE)
          write.csv(out, file = "bench/install-benchmark.csv", row.names = FALSE)
        shell: Rscript {0}

      - name: Upload benchmark artifact
        uses: actions/upload-artifact@v4
        with:
          name: install-benchmark-text-${{ matrix.os }}
          path: bench/install-benchmark.csv
